<!DOCTYPE html>
<html>
  <head>
    <title>TM in Thunkable</title>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  </head>
  <body>
    <h2 id="status">รอรับภาพจาก Thunkable...</h2>
    <img id="preview" width="200" />
    
    <script>
      const URL = "https://teachablemachine.withgoogle.com/models/U7Zrx7V59/";
      let model;

      async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        document.getElementById("status").innerText = "โหลดโมเดลเสร็จแล้ว พร้อมรับภาพ...";
      }

      init();

      // รอฟังข้อความจาก Thunkable
      document.addEventListener("message", async function(event) {
        const base64Image = event.data;

        // แสดงภาพที่รับเข้ามา
        const img = document.getElementById("preview");
        img.src = base64Image;

        // รอให้โหลดภาพเสร็จ
        img.onload = async () => {
          const prediction = await model.predict(img);
          const topResult = prediction.sort((a, b) => b.probability - a.probability)[0];

          // แสดงผลลัพธ์
          document.getElementById("status").innerText = `ผลลัพธ์: ${topResult.className}`;

          // ส่งกลับไปยัง Thunkable
          window.ReactNativeWebView.postMessage(topResult.className);
        };
      });
    </script>
  </body>
</html>
