<!DOCTYPE html>
<html>
  <head>
    <title>TM in Thunkable</title>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  </head>
  <body>
    <h3 id="status">รอรับภาพจาก Thunkable...</h3>
    <img id="preview" width="200" />
    <script>
      const URL = "https://teachablemachine.withgoogle.com/models/U7Zrx7V59/";
      let model;

      async function loadModel() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";
        try {
    model = await tmImage.load(modelURL, metadataURL);
    document.getElementById("status").innerText = "พร้อมรับภาพจาก Thunkable แล้ว...";
  } catch (err) {
    document.getElementById("status").innerText = "โหลดโมเดลไม่สำเร็จ";
    console.error(err);
  }
      }

      loadModel();

      function handleMessage(event) {
        const data = event.data;

        if (!data.startsWith("data:image")) {
          document.getElementById("status").innerText = "ข้อมูลที่รับไม่ใช่รูปภาพ";
          return;
        }

        const img = document.getElementById("preview");
        img.src = data;
        document.getElementById("status").innerText = "ประมวลผล...";

        img.onload = async () => {
          try {
            const prediction = await model.predict(img);
            const top = prediction.sort((a, b) => b.probability - a.probability)[0];

            document.getElementById("status").innerText = `ผลลัพธ์: ${top.className}`;

            if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
              window.ReactNativeWebView.postMessage(top.className);
            } else {
              window.parent.postMessage(top.className, "*");
            }
          } catch (err) {
            document.getElementById("status").innerText = "เกิดข้อผิดพลาดในการประมวลผล";
          }
        };
      }

      document.addEventListener("message", handleMessage);
      window.addEventListener("message", handleMessage);
    </script>
  </body>
</html>
