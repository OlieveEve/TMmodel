<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Teachable Machine in Thunkable</title>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>
<body>
  <h2 id="status">กำลังโหลดโมเดล...</h2>
  <img id="preview" width="200" />
  <script>
    const URL = "https://olieveeve.github.io/TMmodel/"; // ← ถูกต้อง
    let model;

    async function loadModel() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      try {
        model = await tmImage.load(modelURL, metadataURL);
        document.getElementById("status").innerText = "พร้อมรับภาพจาก Thunkable แล้ว...";
      } catch (err) {
        console.error("ERROR loading model:", err);
        document.getElementById("status").innerText = "โหลดโมเดลไม่สำเร็จ";
      }
    }

    loadModel();

    function handleMessage(event) {
      const data = event.data;

      if (!data.startsWith("data:image")) {
        document.getElementById("status").innerText = "ไม่ใช่ข้อมูลภาพ";
        return;
      }

      const img = document.getElementById("preview");
      img.src = data;
      document.getElementById("status").innerText = "กำลังประมวลผล...";

      img.onload = async () => {
        try {
          const prediction = await model.predict(img);
          const top = prediction.sort((a, b) => b.probability - a.probability)[0];
          document.getElementById("status").innerText = `ผลลัพธ์: ${top.className}`;

          if (window.ReactNativeWebView?.postMessage) {
            window.ReactNativeWebView.postMessage(top.className);
          } else {
            window.parent.postMessage(top.className, "*");
          }
        } catch (err) {
          console.error("ERROR during prediction:", err);
          document.getElementById("status").innerText = "เกิดข้อผิดพลาดในการประมวลผล";
        }
      };
    }

    document.addEventListener("message", handleMessage);
    window.addEventListener("message", handleMessage);
  </script>
</body>
</html>
